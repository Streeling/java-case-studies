<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head> 
    <title>Getting Started: Serving Web Content</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
    <p th:text="'Status: '" />
    <form>
        <input type="button" name="start" value="Connect"/>
        <input type="button" name="stop" value="Disconnect"/>
    </form>

    <script src="/js/jquery-3.5.1.js" type="text/javascript"></script>
    <script src="/js/sockjs.min.js" type="text/javascript"></script>
    <script src="/js/stomp.min.js" type="text/javascript" th:inline="javascript"></script>
    <script>
        var socket;
        var stompClient;

        $(function() {
            $("input[type=button][name=start]").click(function() {
                socket = new SockJS('http://localhost:8080/gs-guide-websocket');
                stompClient = Stomp.over(socket);

                var headerName = "[[${_csrf.headerName}]]";
                var token = "[[${_csrf.token}]]";
                var headers = {};
                headers[headerName] = token;
                var stompDestination = "[[${stompDestination}]]";

                stompClient.connect(headers, function () {alert(socket._transport.url);
                    if (stompClient) {
                        stompClient.send("/app/start", {});
                    }

                    alert(stompClient.ws._transport.url);
                    var url = stompClient.ws._transport.url;
                    url = url.replace(
                        "ws://localhost:8080/gs-guide-websocket/",  "");
                    url = url.replace("/websocket", "");
                    url = url.replace(/^[0-9]+\//, "");
                    console.log("Your current session is: " + url);
                    sessionId = url;

                    // stompClient.subscribe('/user/topic/greetings', function (response) {
                    stompClient.subscribe(stompDestination+sessionId, function (response) {
                        console.log('Got ' + response);
                        $( "p" ).text( "Status: " + JSON.parse(response.body).text );
                    });
                    console.info('connected!')
                });
            });
            $("input[type=button][name=stop]").click(function() {
                if (stompClient) {
                    stompClient.send("/app/stop", {});
                }
            });
        });
    </script>
</body>
</html>
